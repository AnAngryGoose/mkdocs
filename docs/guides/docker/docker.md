---
tags:
  - docker
  - service
  - documentation
---

# Docker Management Guide: Homelab Reference

## 1. Overview

This document provides a technical reference for managing Docker, Docker Compose, and data persistence (Volumes) in a homelab environment.

- **Docker:** A platform that virtualizes the OS, running applications in isolated environments called "containers."
    
- **Docker Compose:** A declarative tool for defining and managing multi-container applications. It uses a `docker-compose.yml` file to configure services, networks, and volumes for a "project."
    
- **Docker Volumes:** The preferred mechanism for persisting data generated by and used by Docker containers. Volumes are managed by Docker (`/var/lib/docker/volumes/`) and are decoupled from the container's lifecycle.
    

## 2. Core Strategies: Storage & Networking

 homelab utilizes two distinct patterns for volume and network management.

### 2.1. Volume Management Strategy

Volumes are essential for data persistence. Containers are ephemeral; volumes are persistent. You use two types of _named volumes_.

#### Strategy 1: Standard (Project-Scoped) Named Volumes

- **Definition:** Volumes are defined in the `docker-compose.yml` file without the `external` flag.
    
- **Lifecycle:** The volume is created when you first run `docker compose up`. The volume's name is prefixed with the project (directory) name (e.g., `core_portainer_data`).
    
- **Risk:** This volume is "owned" by the Compose project. Running `docker compose down -v` **will permanently delete this volume and all its data.**
    
- **Use Case:** Good for non-critical data, caches, or applications where data is easily reproducible. (e.g.,  `core` stack).
    

#### Strategy 2: External Named Volumes

- **Definition:** Volumes are created manually _before_ running Compose, using `docker volume create <name>`. The `docker-compose.yml` file then references them using `external: true`.
    
- **Lifecycle:** The volume's lifecycle is **decoupled** from the Compose project. You can run `docker compose down -v`, destroy the container, or recreate the project, and the data remains untouched.
    
- **Risk:** Low. Data is safe from accidental deletion via Compose commands.
    
- **Use Case:** **Recommended for all critical data.** (e.g.,  `omada` stack, `couchdb_data`, `portainer_data`).
    

**Note on Bind Mounts:** A third type, a bind mount, maps a host path directly (e.g., `- /home/user/my-config:/config`). This is **not** a named volume and can create permission issues if not managed carefully.

### 2.2. Network Management Strategy

Containers in a project must be able to communicate.

#### Strategy 1: Default Bridge Network

- **Definition:** By default, Docker Compose creates a new "bridge" network for  project (e.g., `core_default`).
    
- **Communication:** All services in the `core` project can reach each other by their service name (e.g., `portainer` can ping `homepage`).
    
- **Isolation:** This network is isolated from the host and other Docker projects. Ports must be explicitly `published` (e.g., `"3000:3000"`) to be accessible from the outside.
    

#### Strategy 2: Host Network

- **Definition:** Used by  `omada-controller` via `network_mode: host`.
    
- **Communication:** This mode bypasses Docker's networking isolation. The container shares the host's networking namespace.
    
- **Behavior:** The service binds _directly_ to  host's IP address. There is no port mapping; if the service listens on port 8043, it's available on `HOST_IP:8043`.
    
- **Use Case:** Required by some applications (like Omada) for service discovery. Can offer a slight performance benefit but reduces security and can cause port conflicts on the host.
    

## 3. Homelab Project Structure

This diagram outlines  `docker-compose.yml` files, the services they manage, and the resources they use.
 - Refer to [[Volumes]] for more information about this specific setup

```
/homelab/docker/
│
├── core/
│   └── docker-compose.yml
│       ├── services:
│       │   ├── portainer
│       │   │   ├── network: core_default (bridge)
│       │   │   ├── volume:  core_portainer_data (standard)
│       │   │   └── device:  /var/run/docker.sock
│       │   │
│       │   ├── homepage
│       │   │   ├── network: core_default (bridge)
│       │   │   ├── volume:  core_homepage_config (standard)
│       │   │   └── device:  /var/run/docker.sock (ro)
│       │   │
│       │   └── couchdb
│       │       ├── network: core_default (bridge)
│       │       └── volume:  core_couchdb_data (standard)
│       │
│       └── volumes:
│           ├── (Defines standard volumes)
│
└── omada/
    └── docker-compose.yml
        ├── services:
        │   └── omada-controller
        │       ├── network: host
        │       ├── volume:  omada_data (external)
        │       ├── volume:  omada_logs (external)
        │       └── volume:  omada_work (external)
        │
        └── volumes:
            ├── (References external volumes)
```

## 4. Annotated Compose Examples

These examples are based on  files and include annotations for best practices and common issues.

### 4.1. `core/docker-compose.yml` (Standard Volumes)

```
services:
  portainer:
    # --- Version Pinning ---
    # Good practice: Pinning to a specific version (2.20.2)
    # prevents an image update from introducing breaking changes.
    image: portainer/portainer-ce:2.20.2
    container_name: portainer
    restart: unless-stopped 
    security_opt:
      - no-new-privileges:true
    volumes:
      # --- Docker Socket Access ---
      # This bind-mount allows Portainer to manage
      # the Docker daemon itself. This is a privileged operation.
      - /var/run/docker.sock:/var/run/docker.sock
      # --- Volume Definition ---
      # This is a standard named volume. For safety,
      # convert to an external volume (see section 2.1).
      - portainer_data:/data
    ports:
      - "9443:9443"
      - "9000:9000"

  homepage:
    image: ghcr.io/gethomepage/homepage:latest
    container_name: homepage
    restart: unless-stopped
    environment:
      # --- CORS / Host Access ---
      # This is required for Homepage to accept requests
      # from multiple domains/IPs (e.g., localhost, Tailscale IP)
      - HOMEPAGE_ALLOWED_HOSTS=mercury.tail474462.ts.net:3000,192.168.0.116:3000,localhost:3000,mercury:3000,100.102.187.93:3000
    volumes:
      # --- Docker Socket (Read-Only) ---
      # Homepage only needs to *read* container status,
      # so mounting the socket :ro (read-only) is more secure.
      - /var/run/docker.sock:/var/run/docker.sock:ro 
      - homepage_config:/app/config 
    ports:
      - "3000:3000"
    # --- File Permissions (PUID/PGID) ---
    # If the container writes to the config volume as 'root',
    # you can have permission errors. Uncommenting this and
    # setting it to  user's ID (find with `id`) fixes this.
    # user: "1000:1000"

  couchdb:
    image: couchdb:3
    container_name: obsidian-couchdb
    restart: unless-stopped
    ports:
      - "5984:5984"
    environment:
      # --- Secret Management ---
      # Hardcoding secrets is a security risk. Best practice
      # is to move these to a `.env` file.
      #
      # 1. Create a file named `.env` in this directory.
      # 2. Add:
      #    COUCHDB_USER_VAL=goose
      #    COUCHDB_PASSWORD_VAL=SECRETPASSWORD
      # 3. Change the lines below to:
      #    - COUCHDB_USER=${COUCHDB_USER_VAL}
      #    - COUCHDB_PASSWORD=${COUCHDB_PASSWORD_VAL}
      - COUCHDB_USER=goose
      - COUCHDB_PASSWORD=SECREPTPASSWORD
    volumes:
      - couchdb_data:/opt/couchdb/data

# This block defines the volumes as project-scoped.
volumes:
  portainer_data:
  homepage_config:
  couchdb_data:
```

### 4.2. `omada/docker-compose.yml` (External Volumes)

```
services:
  omada-controller:
    image: mbentley/omada-controller:latest
    container_name: omada-controller
    restart: always
    # --- Host Networking ---
    # Bypasses Docker networking, binding directly to host's
    # network. Required by this container.
    network_mode: host
    environment:
      - TZ=America/Chicago
    volumes:
      # --- External Volume Mounts ---
      # These volumes are expected to exist *before*
      # this file is run. They are not managed by Compose.
      - omada_data:/opt/tplink/EAPController/data
      - omada_logs:/opt/tplink/EAPController/logs
      - omada_work:/opt/tplink/EAPController/work

# This block defines the volumes as external.
# This prevents `docker compose down -v` from deleting them.
volumes:
  omada_data:
    external: true
  omada_logs:
    external: true
  omada_work:
    external: true
```

## [[Docker Cheat Sheet]]

### Docker Compose (Project-level)

_Manages the lifecycle of services in `docker-compose.yml`._

|Command|Description|
|---|---|
|`docker compose up -d`|Start/recreate all services in detached (background) mode.|
|`docker compose down`|Stop and remove all containers, networks.|
|`docker compose down -v`|**DANGER:** Stops, removes containers AND **deletes standard (non-external) volumes.**|
|`docker compose pull`|Pulls the latest images for all services defined in the file.|
|`docker compose logs -f`|Follow (stream) the logs for all services in the project.|
|`docker compose exec <svc> <cmd>`|Execute a command (e.g., `/bin/bash`) in a running service.|

### Docker Container (Individual)

_Manages individual containers._

|Command|Description|
|---|---|
|`docker ps`|Lists all _running_ containers.|
|`docker ps -a`|Lists all containers, including stopped ones.|
|`docker logs <container>`|Shows the logs for a specific container.|
|`docker restart <container>`|Restarts a running container.|
|`docker stop <container>`|Stops a running container.|
|`docker rm <container>`|Removes a _stopped_ container.|

### Docker Volume (Data)

_Manages persistent data volumes._

|Command|Description|
|---|---|
|`docker volume ls`|Lists all named volumes on  system.|
|`docker volume create <name>`|**(Manual step for External Volumes)** Creates a new named volume.|
|`docker volume rm <name>`|Deletes a named volume. **Data will be lost.** (Cannot delete if in use).|
|`docker volume inspect <name>`|Shows details about a volume, including its on-disk mountpoint.|

## 6. Workflows

### 6.1. Deploying a New Stack (External Volume Method)

This is the recommended, safe workflow for critical services.

1. **Create Volumes:** Manually create the volumes first.
    
    ```
    docker volume create omada_data
    docker volume create omada_logs
    docker volume create omada_work
    ```
    
2. **Deploy Stack:**
    
    ```
    # (cd into the /omada/ directory)
    docker compose up -d
    ```
    

### 6.2. Updating a Running Stack (Image Pull)

This workflow pulls the latest images and recreates containers that have changed.

```
# (cd into the project directory, e.g., /core/)

# 1. Pull the newest images defined in  compose file
docker compose pull

# 2. Re-create any containers whose images were updated
#    Docker only recreates what's necessary.
docker compose up -d
```

### 6.3. Backing Up a Volume

This command runs a temporary container to `tar` the contents of a volume into a backup file on  host.

```
# This example backs up the 'core_homepage_config' volume
# to a file named 'homepage_backup.tar.gz' in  current directory.

docker run --rm \
  -v core_homepage_config:/data:ro \
  -v $(pwd):/backup \
  alpine \
  tar czf /backup/homepage_backup.tar.gz -C /data .
```

## 7. Official Documentation Links

- **Docker Volumes:** [https://docs.docker.com/storage/volumes/](https://docs.docker.com/storage/volumes/ "null")
    
- **Docker Compose File Reference:** [https://docs.docker.com/compose/compose-file/](https://docs.docker.com/compose/compose-file/ "null")
    
- **`docker volume create` CLI:** [https://docs.docker.com/engine/reference/commandline/volume_create/](https://docs.docker.com/engine/reference/commandline/volume_create/ "null")
    
- **Compose `network_mode`:** [https://docs.docker.com/compose/compose-file/05-services/#network_mode](https://www.google.com/search?q=https://docs.docker.com/compose/compose-file/05-services/%23network_mode "null")
    
- **`.env` files in Compose:** [https://docs.docker.com/compose/environment-variables/set-environment-variables/](https://docs.docker.com/compose/environment-variables/set-environment-variables/ "null")